import numpy as np
import matplotlib.pyplot as plt
from scipy.signal import stft
import re

fs = 61.440e6 # 245.760 * 1e6 # MHz 

windowsSize = 32
overlapFrac = 7/10 # 1/2 = 50% windows overlap

# Load data from CSV
data = np.loadtxt('chirps_128_data_local.csv', delimiter=',', skiprows=1)

# data = []
# # resample data
# factor = int(245.760e6 / fs)
# for idx, i in enumerate(data_raw):
#     if(idx % factor == 0):
#         data.append(i)
# data = np.array(data)

print(f"data shape: {data.shape}")

# data = np.array([
#     [32767, 32766, 32766, 32766, 32766, 32766, 32766, 32765, 32765, 32764, 32762, 32760, 32757, 32754, 32750, 32744, 32738, 32730, 32720, 32709, 32696, 32681, 32664, 32644, 32621, 32595, 32566, 32534, 32497, 32457, 32412, 32362, 32308, 32248, 32182, 32110, 32033, 31948, 31856, 31757, 31650, 31535, 31411, 31278, 31136, 30984, 30822, 30649, 30465, 30270, 30063, 29844, 29611, 29366, 29107, 28834, 28547, 28244, 27927, 27594, 27244, 26879, 26496, 26096, 25679, 25243, 24790, 24318, 23827, 23317, 22787, 22238, 21669, 21080, 20470, 19840, 19190, 18519, 17828, 17116, 16383, 15630, 14856, 14062, 13249, 12415, 11562, 10689, 9798, 8889, 7961, 7017, 6055, 5078, 4085, 3078, 2057, 1023, -21, -1077, -2143, -3217, -4298, -5385, -6476, -7571, -8667, -9762, -10856, -11947, -13033, -14111, -15180, -16239, -17284, -18315, -19329, -20323, -21296, -22246, -23169, -24065, -24930, -25762, -26559, -27319, -28038, -28716, -29349, -29936, -30473, -30960, -31393, -31770, -32090, -32350, -32549, -32685, -32756, -32760, -32696, -32563, -32360, -32085, -31737, -31316, -30822, -30254, -29611, -28895, -28105, -27241, -26305, -25298, -24221, -23074, -21861, -20583, -19242, -17841, -16383, -14871, -13307, -11697, -10043, -8351, -6623, -4866, -3083, -1281, 536, 2362, 4191, 6018, 7836, 9639, 11421, 13175, 14895, 16573, 18204, 19780, 21296, 22745, 24119, 25414, 26622, 27737, 28755, 29668, 30473, 31164, 31737, 32187, 32511, 32705, 32766, 32693, 32483, 32136, 31650, 31026, 30264, 29366, 28334, 27170, 25877, 24461, 22925, 21276, 19519, 17661, 15710, 13674, 11562, 9383, 7147, 4866, 2549, 209, -2143, -4494, -6833, -9146, -11421, -13645, -15804, -17886, -19879, -21769, -23545, -25196, -26709, -28074, -29282, -30323, -31189, -31872, -32366, -32666, -32767, -32665, -32360, -31850, -31136, -30221, -29107, -27800, -26305, -24631, -22787, -20783, -18630, -16341, -13932, -11416, -8811, -6134, -3403, -637, 2143, 4919, 7670, 10375, 13013, 15564, 18007, 20323, 22493, 24497, 26318, 27941, 29349, 30530, 31471, 32163, 32596, 32764, 32664, 32292, 31650, 30739, 29565, 28135, 26458, 24546, 22414, 20078, 17557, 14871, 12042, 9095, 6055, 2950, -193, -3345, -6476, -9557, -12559, -15450, -18204, -20791, -23184, -25359, -27292, -28960, -30346, -31431, -32202, -32648, -32762, -32539, -31977, -31081, -29855, -28309, -26458, -24318, -21909, -19255, -16383, -13322, -10105, -6765, -3339, 134, 3616, 7069, 10451, 13723, 16845, 19780, 22493, 24947, 27112, 28960, 30465, 31607, 32366, 32732, 32696, 32255, 31411, 30171, 28547, 26556, 24221, 21568, 18630, 15441, 12042, 8475, 4786, 1023, -2763, -6523, -10207, -13762, -17138, -20290, -23169, -25735, -27949, -29777, -31189, -32163, -32680, -32730, -32308, -31416, -30063, -28266, -26047, -23437, -20470, -17189, -13640, -9875, -5950, -1923, 2143, 6187, 10145, 13956, 17557, 20890, 23900, 26537, 28755, 30515, 31785, 32540, 32765, 32451, 31599, 30221, 28334, 25966, 23154, 19943, 16383, 12534, 8460, 4229, -85, -4409, -8667, -12781, -16679, -20290, -23545, -26385, -28755, -30607, -31906, -32622, -32738, -32248, -31156, -29479, -27244, -24490, -21264, -17625, -13640, -9383, -4935, -380, 4191, 8692, 13033, 17125, 20886, 24239, 27112, 29446, 31189, 32301, 32756, 32539, 31650, 30103, 27927, 25161, 21861, 18092, 13932, 9465, 4786, -5, -4807, -9516, -14029, -18244, -22068, -25414, -28203, -30372, -31866, -32648, -32696, -32004, -30582, -28459, -25679, -22301, -18400, -14062, -9388, -4484, 536, 5554, 10451, 15109, 19415, 23264, 26559, 29217, 31169, 32364, 32767, 32362, 31156, 29173, 26458, 23074, 19103, 14641, 9798, 4696, -536, -5765, -10856, -15677, -20100, -24006, -27292, -29866, -31656, -32609, -32696, -31909, -30264, -27800, -24578, -20683, -16216, -11295, -6055, -637, 4807, 10130, 15180, 19815, 23900, 27319, 29968, 31770, 32667, 32629, 31650, 29754, 26991, 23437, 19190, 14372, 9121, 3590, -2057, -7654, -13033, -18030, -22493, -26283, -29282, -31394, -32549, -32707, -31856, -30018, -27244, -23616, -19242, -14256, -8811, -3078, 2763, 8527, 14029, 19090, 23545, 27247, 30072, 31921, 32731, 32468, 31136, 28773, 25451, 21276, 16383, 10932, 5104, -905, -6896, -12663, -18007, -22745, -26709, -29759, -31785, -32710, -32497, -31148, -28703, -25243, -20886, -15780, -10105, -4058, 2143, 8278, 14125, 19471, 24119, 27896, 30659, 32301, 32757, 32004, 30063, 27001, 22925, 17985, 12360, 6261, -85, -6439, -12559, -18208, -23169, -27247, -30280, -32146, -32766, -32110, -30198, -27097, -22925, -17841, -12042, -5755, 771, 7278, 13503, 19194, 24119, 28074, 30894, 32458, 32696, 31592, 29185, 25569, 20886, 15327, 9121, 2522, -4191, -10740, -16845, -22246, -26709, -30040, -32090, -32766, -32033, -29914, -26496, -21921, -16383, -10120, -3403, 3473, 10207, 16499, 22068, 26662, 30072, 32138, 32762, 31909, 29611, 25966, 21133, 15327, 8811, 1880, -5147, -11947, -18204, -23623, -27949, -30974, -32549, -32595, -31103, -28135, -23827, -18377, -12042, -5120, 2057, 9146, 15804, 21705, 26559, 30125, 32222, 32741, 31650, 28995, 24902, 19566, 13249, 6261, -1050, -8320, -15180, -21284, -26318, -30022, -32202, -32739, -31599, -28834, -24578, -19046, -12519, -5332, 2143, 9516, 16402, 22434, 27292, 30713, 32511, 32582, 30916, 27594, 22787, 16748, 9798, 2308, -5316, -12663, -19329, -24947, -29205, -31862, -32767, -31860, -29185, -24884, -19190, -12415, -4935, 2832, 10451, 17489, 23545, 28271, 31393, 32724, 32182, 29790, 25679, 20078, 13307, 5755, -2143, -9926, -17138, -23354, -28203, -31394, -32731, -32127, -29611, -25325, -19519, -12534, -4786, 3259, 11119, 18315, 24407, 29020, 31866, 32764, 31650, 28586, 23753, 17444, 10043, 2009, -6160, -13956, -20886, -26512, -30473, -32514, -32497, -30416, -26395, -20683, -13640, -5712, 2592, 10740, 18204, 24497, 29205, 32015, 32738, 31316, 27837, 22520, 15710, 7852, -536, -8899, -16679, -23354, -28473, -31684, -32766, -31637, -28366, -23165, -16383, -8475, 21, 8527, 16457, 23264, 28473, 31717, 32765, 31535, 28105, 22706, 15710, 7602, -1050, -9639, -17557, -24239, -29205, -32095, -32696, -30956, -26991, -21080, -13640, -5205, 3616, 12186, 19879, 26129, 30473, 32588, 32308, 29646, 24790, 18092, 10043, 1238, -7670, -16015, -23169, -28591, -31866, -32739, -31136, -27170, -21133, -13479, -4786, 4282, 13033, 20791, 26955, 31043, 32731, 31880, 28547, 22983, 15616, 7017, -2143, -11144, -19277, -25894, -30465, -32622, -32182, -29173, -23827, -16564, -7961, 1291, 10451, 18775, 25585, 30323, 32596, 32209, 29185, 23764, 16383, 7644, -1736, -10983, -19329, -26077, -30659, -32685, -31977, -28586, -22787, -15061, -6055, 3473, 12717, 20890, 27292, 31370, 32766, 31354, 27244, 20783, 12519, 3163, -6476, -15564, -23305, -29020, -32202, -32563, -30063, -24912, -17557, -8641, 1050, 10659, 19329, 26283, 30894, 32741, 31650, 27709, 21264, 12890, 3339, -6523, -15804, -23653, -29349, -32364, -32412, -29479, -23827, -15968, -6623, 3345, 13013, 21479, 27949, 31812, 32696, 30511, 25451, 17985, 8811, -1206, -11119, -19985, -26955, -31357, -32762, -31026, -26305, -19046, -9941, 134, 10207, 19298, 26521, 31164],
#     [0, 5, 21, 48, 85, 134, 193, 262, 343, 434, 536, 648, 771, 905, 1050, 1206, 1372, 1548, 1736, 1934, 2143, 2362, 2592, 2832, 3083, 3345, 3616, 3899, 4191, 4494, 4807, 5131, 5464, 5807, 6160, 6523, 6896, 7278, 7670, 8070, 8480, 8899, 9326, 9762, 10207, 10659, 11119, 11587, 12062, 12544, 13033, 13528, 14029, 14535, 15047, 15564, 16085, 16610, 17138, 17670, 18204, 18740, 19277, 19815, 20353, 20890, 21426, 21961, 22493, 23021, 23545, 24065, 24578, 25086, 25585, 26077, 26559, 27031, 27492, 27941, 28377, 28798, 29205, 29595, 29968, 30323, 30659, 30974, 31267, 31538, 31785, 32006, 32202, 32371, 32511, 32622, 32702, 32750, 32766, 32749, 32696, 32608, 32483, 32321, 32120, 31880, 31599, 31278, 30916, 30511, 30063, 29572, 29038, 28459, 27837, 27170, 26458, 25702, 24902, 24057, 23169, 22238, 21264, 20247, 19190, 18092, 16955, 15780, 14569, 13322, 12042, 10730, 9388, 8018, 6623, 5205, 3766, 2308, 836, -648, -2143, -3643, -5147, -6649, -8148, -9639, -11119, -12583, -14029, -15450, -16845, -18208, -19536, -20824, -22068, -23264, -24407, -25495, -26521, -27483, -28377, -29198, -29942, -30607, -31189, -31684, -32090, -32403, -32621, -32741, -32762, -32681, -32497, -32209, -31816, -31316, -30711, -30001, -29185, -28266, -27244, -26122, -24902, -23586, -22179, -20683, -19103, -17444, -15710, -13907, -12042, -10120, -8148, -6134, -4085, -2009, 85, 2191, 4298, 6397, 8480, 10537, 12559, 14535, 16457, 18315, 20100, 21801, 23411, 24919, 26318, 27599, 28755, 29777, 30659, 31394, 31977, 32403, 32667, 32766, 32696, 32457, 32046, 31464, 30711, 29790, 28703, 27454, 26047, 24490, 22787, 20948, 18981, 16896, 14703, 12415, 10043, 7602, 5104, 2565, 0, -2576, -5147, -7696, -10207, -12663, -15047, -17344, -19536, -21608, -23545, -25332, -26955, -28401, -29657, -30713, -31559, -32187, -32589, -32760, -32696, -32395, -31856, -31081, -30072, -28834, -27375, -25702, -23827, -21761, -19519, -17116, -14569, -11897, -9121, -6261, -3339, -380, 2592, 5554, 8480, 11346, 14125, 16794, 19329, 21705, 23900, 25894, 27666, 29198, 30473, 31479, 32202, 32633, 32766, 32595, 32120, 31342, 30264, 28895, 27244, 25325, 23154, 20749, 18132, 15327, 12360, 9260, 6055, 2779, -536, -3856, -7147, -10375, -13503, -16499, -19329, -21961, -24364, -26512, -28377, -29936, -31169, -32060, -32596, -32766, -32566, -31995, -31055, -29754, -28105, -26122, -23827, -21243, -18400, -15327, -12062, -8641, -5104, -1495, 2143, 5765, 9326, 12781, 16085, 19194, 22068, 24667, 26955, 28900, 30473, 31651, 32415, 32750, 32650, 32110, 31136, 29736, 27927, 25729, 23169, 20281, 17102, 13674, 10043, 6261, 2378, -1548, -5464, -9311, -13033, -16573, -19879, -22899, -25585, -27896, -29792, -31243, -32222, -32710, -32696, -32177, -31156, -29646, -27666, -25243, -22414, -19220, -15710, -11937, -7961, -3846, 343, 4537, 8667, 12663, 16457, 19985, 23184, 25999, 28377, 30274, 31656, 32492, 32766, 32468, 31599, 30171, 28203, 25729, 22787, 19428, 15710, 11697, 7461, 3078, -1372, -5807, -10145, -14304, -18204, -21769, -24930, -27622, -29792, -31394, -32393, -32764, -32497, -31592, -30063, -27935, -25247, -22048, -18400, -14372, -10043, -5501, -836, 3856, 8480, 12939, 17138, 20989, 24407, 27319, 29657, 31370, 32415, 32766, 32412, 31354, 29611, 27217, 24221, 20683, 16679, 12296, 7628, 2779, -2143, -7027, -11762, -16239, -20353, -24006, -27112, -29595, -31393, -32458, -32762, -32292, -31055, -29075, -26395, -23074, -19190, -14832, -10105, -5120, 0, 5131, 10145, 14918, 19329, 23264, 26622, 29313, 31267, 32428, 32762, 32255, 30916, 28773, 25877, 22301, 18132, 13479, 8460, 3206, -2143, -7445, -12559, -17344, -21669, -25414, -28473, -30758, -32202, -32760, -32412, -31161, -29038, -26096, -22414, -18092, -13249, -8018, -2549, 3003, 8480, 13723, 18577, 22899, 26559, 29446, 31471, 32569, 32702, 31860, 30063, 27360, 23827, 19566, 14703, 9383, 3766, -1977, -7670, -13136, -18204, -22714, -26521, -29503, -31559, -32622, -32650, -31637, -29611, -26631, -22787, -18199, -13013, -7393, -1522, 4409, 10207, 15677, 20637, 24919, 28377, 30889, 32366, 32754, 32033, 30221, 27375, 23586, 18981, 13713, 7961, 1923, -4191, -10171, -15804, -20890, -25247, -28716, -31169, -32514, -32696, -31703, -29565, -26353, -22179, -17189, -11562, -5501, 771, 7027, 13033, 18563, 23411, 27389, 30346, 32163, 32766, 32127, 30264, 27241, 23169, 18199, 12519, 6345, -85, -6523, -12717, -18422, -23411, -27483, -30473, -32257, -32757, -31948, -29855, -26556, -22179, -16896, -10917, -4484, 2143, 8692, 14895, 20491, 25247, 28960, 31471, 32669, 32497, 30956, 28105, 24057, 18981, 13087, 6623, -134, -6896, -13371, -19277, -24354, -28377, -31164, -32589, -32582, -31136, -28309, -24221, -19046, -13013, -6387, 536, 7445, 14029, 19985, 25041, 28960, 31559, 32712, 32360, 30511, 27244, 22706, 17102, 10689, 3766, -3345, -10308, -16794, -22493, -27128, -30473, -32364, -32702, -31464, -28703, -24546, -19190, -12890, -5950, 1291, 8480, 15261, 21296, 26283, 29968, 32163, 32750, 31693, 29038, 24912, 19519, 13126, 6055, -1334, -8667, -15564, -21669, -26662, -30280, -32330, -32696, -31354, -28366, -23882, -18132, -11416, -4085, 3473, 10856, 17670, 23545, 28162, 31267, 32685, 32332, 30221, 26458, 21243, 14856, 7644, 0, -7654, -14895, -21317, -26559, -30323, -32393, -32644, -31055, -27709, -22787, -16564, -9388, -1666, 6160, 13645, 20353, 25894, 29942, 32257, 32696, 31227, 27927, 22983, 16679, 9383, 1522, -6439, -14029, -20791, -26318, -30274, -32415, -32604, -30822, -27170, -21861, -15214, -7628, 434, 8480, 16015, 22570, 27737, 31189, 32705, 32182, 29646, 25247, 19255, 12042, 4058, -4191, -12186, -19415, -25414, -29792, -32265, -32664, -30956, -27244, -21761, -14856, -6975, 1372, 9639, 17284, 23801, 28755, 31812, 32762, 31535, 28203, 22983, 16216, 8351, -85, -8527, -16402, -23173, -28377, -31651, -32766, -31637, -28334, -23074, -16216, -8226, 343, 8899, 16845, 23623, 28755, 31872, 32750, 31316, 27666, 22048, 14856, 6597, -2143, -10740, -18577, -25086, -29792, -32350, -32566, -30416, -26047, -19772, -12042, -3419, 5464, 13956, 21426, 27319, 31189, 32743, 31856, 28586, 23169, 16005, 7628, -1334, -10207, -18315, -25041, -29866, -32415, -32485, -30063, -25325, -18630, -10486, -1522, 7571, 16085, 23354, 28806, 32006, 32696, 30813, 26496, 20078, 12062, 3078, -6160, -14918, -22493, -28271, -31785, -32741, -31055, -26854, -20470, -12415, -3339, 6018, 14895, 22559, 28377, 31862, 32720, 30871, 26458, 19840, 11562, 2308, -7147, -16015, -23545, -29100, -32202, -32582, -30198, -25243, -18132, -9465, 21, 9516, 18204, 25332, 30280, 32613, 32120, 28834, 23032, 15214, 6055, -3643, -13033, -21284, -27666, -31607, -32750, -30984, -26458, -19566, -10917, -1281, 8480, 17489, 24930, 30125, 32596, 32110, 28703, 22675, 14569, 5120, -4807, -14304, -22493, -28612, -32090, -32595, -30072, -24744, -17102, -7852, 2143, 11947, 20637, 27389, 31559, 32744, 30822, 25966, 18630, 9506, -536, -10537, -19536, -26662, -31222, -32766, -31136, -26480, -19242, -10120]]
# )
print(data.shape)

# Separate real and imaginary parts
real_parts = data[:, 0] #data[0]
imag_parts = data[:, 1] #data[1]

# carr = np.abs(real_parts + 1j*imag_parts)

f, t, Zxx = stft(real_parts, fs=fs, nperseg=windowsSize, noverlap=windowsSize*overlapFrac, nfft=4096)
f /= 1e6
t *= 1e6

# maxPlotFreq = (20) * 1.3
# lastIndex = np.argwhere(f > maxPlotFreq)[0][0]
# f = f[:lastIndex]
# Zxx = Zxx[:lastIndex,:]

plt.figure(layout="constrained")
plt.subplot(311)
plt.plot(real_parts)
plt.ylabel('Amplitude')
plt.xlabel('Sample (I)')

plt.subplot(312)
plt.plot(imag_parts)
plt.ylabel('Amplitude')
plt.xlabel('Sample (Q)')

plt.subplot(313)
plt.pcolormesh(t, f, np.abs(Zxx), shading='gouraud')
plt.ylabel('MHz')
plt.xlabel('mus (I)')

plt.show()